---

devture_systemd_service_manager_enabled: true

# devture_systemd_service_manager_services_list_auto contains a list of systemd services and their priorities.
# This list is managed by the playbook. You're not meant to override this variable.
# To add your own items to the list, use `devture_systemd_service_manager_services_list_additional`
devture_systemd_service_manager_services_list_auto: []

# devture_systemd_service_manager_services_list_additional contains your own list of systemd services and their priorities.
#
# Example:
# devture_systemd_service_manager_services_list_additional:
#   - name: some-service.service
#     priority: 1250
#     groups: ['core', 'special']
#   - name: another-service.service
#     priority: 3500
#     groups: ['addon', 'reverse-proxy']
devture_systemd_service_manager_services_list_additional: []

# devture_systemd_service_manager_services_list contains a list of systemd services and their priorities.
devture_systemd_service_manager_services_list: "{{ devture_systemd_service_manager_services_list_auto + devture_systemd_service_manager_services_list_additional }}"

# devture_systemd_service_manager_service_restart_mode specifies how services are restarted.
#
# Supported values:
# - `clean-stop-start` - services are stopped cleanly (higher priority level stopped earlier) and then started (lower priority level started earlier)
# - `one-by-one` - services are restarted one by one (lower priority level earlier)
# - `priority-batched` - services are started/restarted in priority batches and queued without blocking inside each batch
# - `all-at-once` - issues a single `systemctl restart svc1 svc2 ... svcN` command, letting systemd handle all restarts in one transaction
#
# The `one-by-one` mode may decrease downtime, but is potentially less reliable and "clean".
# The `priority-batched` mode queues all services within a priority level concurrently (non-blocking), then proceeds to the next priority level.
#
# For a detailed comparison of these modes with real-world downtime benchmarks,
# see docs/restart-mode-comparison.md
#
# The `all-at-once` mode uses `ansible.builtin.command` to invoke `systemctl restart` (or `start`) with all service names
# as arguments in a single call. This is necessary because Ansible's `service`/`systemd` modules only accept a single
# service name (`name: type=str`), making it impossible to pass multiple services to them.
#
# systemd handles ordering via its own dependency graph (`After=`/`Before=` directives), not the CLI argument order,
# so the order of service names on the command line does not matter. The call is blocking â€” `systemctl` waits for all
# restarts to complete before returning.
#
# Error behavior differs from loop-based modes: if one service fails to restart, systemd still attempts all others
# (unlike `one-by-one` or `clean-stop-start`, where Ansible stops the loop at first failure).
# The verification step then catches individual failures.
#
# This mode is particularly useful when a VPN service (e.g., WireGuard) is among the managed services.
# With `clean-stop-start`, the VPN is stopped during the stop phase, causing connectivity loss that prevents
# the start phase from reaching the server. The `all-at-once` mode avoids this by letting systemd handle
# the restart transaction internally on the server side.
devture_systemd_service_manager_service_restart_mode: all-at-once

# devture_systemd_service_manager_services_autostart_enabled controls whether systemd services should auto-start when the system reboots
devture_systemd_service_manager_services_autostart_enabled: true

# devture_systemd_service_manager_up_verification_enabled controls whether this role will verify if the services did manage to start successfully
devture_systemd_service_manager_up_verification_enabled: true

# devture_systemd_service_manager_up_verification_delay_seconds specifies how long to wait between starting systemd services and checking if they're started.
#
# A too low value may lead to a failure, as services may not have enough time to start and potentially fail.
#
# A value higher than 30 seconds (or any multiple of that) may also not work well, because a failing systemd service
# auto-restarts after 30 seconds (`RestartSec=30` in systemd service files).
# Checking if a service is running right after it had potentially restarted in such a way will lead us to
# thinking it's running, while it's merely starting again (and likely to fail again, given that it already did once).
#
# All of the services we manage are also started sequentially, which in itself can take a long time.
# There may be a ~10 second (or even larger) interval between starting the first service and starting the last one.
# This makes it even harder to pick a correct value. Such a 10 second gap and a waiting time of 20 seconds will
# put us right at the "dangerous" 30-second mark.
#
# We can try to measure this gap and adjust our waiting time accordingly, but we currently don't.
devture_systemd_service_manager_up_verification_delay_seconds: 15
